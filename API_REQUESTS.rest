###
# üß™ COLECCI√ìN REST - TaskFlow API
# 
# URL Base: http://localhost:8000
# Autenticaci√≥n: Bearer Token (JWT)
# Token v√°lido por: 24 horas
# 
# VARIABLES A REEMPLAZAR:
# {{token}}             - Token JWT del usuario admin
@token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJhZG1pbiIsInJvbGUiOiJhZG1pbiIsImV4cCI6MTc2MjY3NzkzOX0.I9itNxCvQnBC6dkEFq3Zh6473epUms1YjvlXwnEpxyQ
# {{token_read_write}}  - Token JWT de usuario con rol read_write
@token_read_write=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyIiwidXNlcm5hbWUiOiJtaWtlLmRldmVsb3BlciIsImV4cCI6MTc2MjY3MTgxMn0.Ec-Djzs_3SP9d045Ti--PqRUgSODmstfc7aWlaYtROU
# {{token_read_only}}   - Token JWT de usuario con rol read_only
@token_read_only=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzIiwidXNlcm5hbWUiOiJsYXVyYS52aWV3ZXIiLCJleHAiOjE3NjI2NzE4NDh9.JYPytQFHAx9MR0Uandofc0tVD5jaq1Yge4cxvU42MgM

@token_expired=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0IiwidXNlcm5hbWUiOiJtYXJpYS52aWV3ZXIiLCJleHAiOjE3NjI1NzcyMjN9.jPoOiApm5AbJjkghagM7FHVXC2VRh9j9ge3MmM4UN78

###

### ==========================================
### 1. AUTENTICACI√ìN
### ==========================================

### 1.1 Login - Obtener Token ADMIN (EJECUTAR PRIMERO)
POST http://localhost:8000/api/auth/login
Content-Type: application/x-www-form-urlencoded

username=admin&password=AdminTaskFlow@2025!


### 1.2 Login - Obtener Token READ_WRITE
POST http://localhost:8000/api/auth/login
Content-Type: application/x-www-form-urlencoded

username=mike.developer&password=123456789

### 1.3 Login - Obtener Token READ_ONLY
POST http://localhost:8000/api/auth/login
Content-Type: application/x-www-form-urlencoded

username=laura.viewer&password=123456789

### 1.4 Login - Credenciales Inv√°lidas (Error 401)
POST http://localhost:8000/api/auth/login
Content-Type: application/x-www-form-urlencoded

username=admin&password=passwordIncorrecto

### 1.5 Get Me - Obtener Datos del Usuario Autenticado
GET http://localhost:8000/api/auth/me
Authorization: Bearer {{token}}

### 1.4 Get Me - Sin Token (Error 401)
GET http://localhost:8000/api/auth/me

### 1.5 Get Me - Token Inv√°lido (Error 401)
GET http://localhost:8000/api/auth/me
Authorization: Bearer token_invalido_xyz

### ==========================================
### 2. GESTI√ìN DE USUARIOS
### ==========================================

### 2.1 Crear Usuario - Como ADMIN (cualquier rol)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "mike.developer",
  "email": "mike.suarez@example.com",
  "password": "123456789",
  "role": "read_only",
  "first_name": "Mike",
  "last_name": "Developer"
}

### 2.2 Crear Usuario - Como READ_WRITE (solo read_only)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "laura.viewer",
  "email": "laura@example.com",
  "password": "123456789",
  "role": "read_only",
  "first_name": "Laura",
  "last_name": "Viewer"
}

### 2.3 Crear Usuario - READ_WRITE intenta crear ADMIN (Error 403)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token_read_write}}
Content-Type: application/json

{
  "username": "new.admin",
  "email": "admin2@example.com",
  "password": "AdminPass123!",
  "role": "admin",
  "first_name": "Nuevo",
  "last_name": "Admin"
}

### 2.4 Crear Usuario - READ_ONLY intenta crear (Error 403)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token_read_only}}
Content-Type: application/json

{
  "username": "otro.user",
  "email": "otro@example.com",
  "password": "Pass123!",
  "role": "read_only",
  "first_name": "Otro",
  "last_name": "User"
}

### 2.5 Crear Usuario - Duplicado username (Error 400)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "admin",
  "email": "nuevo@example.com",
  "password": "Pass123!",
  "role": "read_only",
  "first_name": "Nuevo",
  "last_name": "User"
}

### 2.6 Crear Usuario - Duplicado email (Error 400)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "nuevo.usuario",
  "email": "admin@example.com",
  "password": "Pass123!",
  "role": "read_write",
  "first_name": "Nuevo",
  "last_name": "User"
}

### 2.7 Crear Usuario - Email inv√°lido (Error 422)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "nuevo.usuario",
  "email": "correo-invalido",
  "password": "Pass123!",
  "role": "read_write"
}

### 2.8 Listar Usuarios - Como ADMIN
GET http://localhost:8000/api/users/?skip=0&limit=10
Authorization: Bearer {{token}}

### 2.9 Listar Usuarios - Como READ_WRITE solo ve read_only y read_write
GET http://localhost:8000/api/users/?skip=0&limit=10
Authorization: Bearer {{token_read_write}}

### 2.10 Listar Usuarios - READ_ONLY solo ve los READ_ONLY
GET http://localhost:8000/api/users/?skip=0&limit=10
Authorization: Bearer {{token_read_only}}

### 2.11 Obtener Usuario por ID
GET http://localhost:8000/api/users/4
Authorization: Bearer {{token}}

### 2.12 Obtener Usuario por ID - No existe (Error 404)
GET http://localhost:8000/api/users/999
Authorization: Bearer {{token}}

### 2.13 Actualizar Usuario - Como ADMIN (cambiar rol)
PATCH http://localhost:8000/api/users/2
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "role": "read_write"
}

### 2.14 Actualizar Usuario - READ_WRITE intenta cambiar a admin (Error 403)
PATCH http://localhost:8000/api/users/3
Authorization: Bearer {{token_read_write}}
Content-Type: application/json

{
  "role": "admin"
}

### 2.15 Desactivar Usuario - Como ADMIN
DELETE http://localhost:8000/api/users/3
Authorization: Bearer {{token}}

### 2.16 Desactivar Usuario - READ_WRITE intenta (Error 403)
DELETE http://localhost:8000/api/users/2
Authorization: Bearer {{token_read_write}}

### 2.17 Cambiar Contrase√±a de Usuario - Como ADMIN
POST http://localhost:8000/api/users/2/change-password
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "new_password": "12345678"
}

### 2.18 Activar Usuario - Como ADMIN
POST http://localhost:8000/api/users/3/activate
Authorization: Bearer {{token}}

### 2.19 Activar Usuario - READ_WRITE intenta (Error 403)
POST http://localhost:8000/api/users/3/activate
Authorization: Bearer {{token_read_write}}

### ==========================================
### 3. GESTI√ìN DE PROYECTOS
### ==========================================

### 3.1 Crear Proyecto - Como ADMIN
POST http://localhost:8000/api/projects
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "App Mobile - Desarrollo",
  "description": "Desarrollo de aplicaci√≥n mobile para iOS y Android"
}

### 3.2 Crear Proyecto - Como READ_WRITE
POST http://localhost:8000/api/projects
Authorization: Bearer {{token_read_write}}
Content-Type: application/json

{
  "name": "Web Platform - Frontend",
  "description": "Desarrollo de plataforma web con React"
}

### 3.3 Crear Proyecto - READ_ONLY intenta (Error 403)
POST http://localhost:8000/api/projects
Authorization: Bearer {{token_read_only}}
Content-Type: application/json

{
  "name": "Backend API",
  "description": "API backend para plataforma"
}

### 3.4 Listar Proyectos - Como ADMIN
GET http://localhost:8000/api/projects?skip=0&limit=10
Authorization: Bearer {{token}}

### 3.5 Listar Proyectos - Como READ_WRITE
GET http://localhost:8000/api/projects?skip=0&limit=10
Authorization: Bearer {{token_read_write}}

### 3.6 Listar Proyectos - Como READ_ONLY
GET http://localhost:8000/api/projects?skip=0&limit=10
Authorization: Bearer {{token_read_only}}

### 3.7 Obtener Proyecto por ID
GET http://localhost:8000/api/projects/1
Authorization: Bearer {{token}}

### 3.8 Obtener Proyecto por ID - No existe (Error 404)
GET http://localhost:8000/api/projects/999
Authorization: Bearer {{token}}

### 3.9 Actualizar Proyecto - Como ADMIN
PATCH http://localhost:8000/api/projects/1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "App Mobile - En Producci√≥n",
  "description": "Aplicaci√≥n mobile en producci√≥n - soporte y mantenimiento"
}

### 3.10 Actualizar Proyecto - READ_WRITE intenta (Error 403)
PATCH http://localhost:8000/api/projects/1
Authorization: Bearer {{token_read_write}}
Content-Type: application/json

{
  "name": "Modified Name"
}

### 3.11 Eliminar Proyecto - Como due√±o
DELETE http://localhost:8000/api/projects/1
Authorization: Bearer {{token}}

### 3.12 Agregar Miembro al Proyecto - Como propietario
POST http://localhost:8000/api/projects/1/members?member_id=2
Authorization: Bearer {{token}}

### 3.13 Agregar Miembro - READ_ONLY intenta (Error 403)
POST http://localhost:8000/api/projects/1/members?member_id=3
Authorization: Bearer {{token_read_only}}

### 3.14 Agregar Miembro - Usuario no propietario intenta (Error 403)
POST http://localhost:8000/api/projects/1/members?member_id=3
Authorization: Bearer {{token_read_write}}

### 3.15 Remover Miembro del Proyecto - Como propietario
DELETE http://localhost:8000/api/projects/1/members/2
Authorization: Bearer {{token}}

### 3.16 Remover Miembro - READ_ONLY intenta (Error 403)
DELETE http://localhost:8000/api/projects/1/members/2
Authorization: Bearer {{token_read_only}}

### 3.17 Remover Miembro - Usuario no propietario intenta (Error 403)
DELETE http://localhost:8000/api/projects/1/members/2
Authorization: Bearer {{token_read_write}}

### ==========================================
### 4. GESTI√ìN DE TAREAS
### ==========================================

### 4.1 Crear Tarea - Como ADMIN
POST http://localhost:8000/api/tasks
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "title": "Implementar autenticaci√≥n",
  "description": "Implementar JWT authentication con roles",
  "priority": "high",
  "status": "in_progress",
  "project_id": 1,
  "assigned_to": 2
}

### 4.2 Crear Tarea - Como READ_WRITE
POST http://localhost:8000/api/tasks
Authorization: Bearer {{token_read_write}}
Content-Type: application/json

{
  "title": "Dise√±ar interfaz de usuario",
  "description": "Dise√±ar UI/UX para dashboard",
  "priority": "medium",
  "project_id": 2
}

### 4.3 Crear Tarea - READ_ONLY intenta (Error 403)
POST http://localhost:8000/api/tasks
Authorization: Bearer {{token_read_only}}
Content-Type: application/json

{
  "title": "Nueva tarea",
  "description": "Descripci√≥n",
  "priority": "low",
  "project_id": 2
}

### 4.4 Listar Tareas del Proyecto
GET http://localhost:8000/api/tasks/project/1
Authorization: Bearer {{token}}

### 4.4a Listar Tareas - Filtrado por Estado
GET http://localhost:8000/api/tasks/project/1?status_filter=completed
Authorization: Bearer {{token}}

### 4.4b Listar Tareas - Filtrado por Prioridad
GET http://localhost:8000/api/tasks/project/1?priority_filter=high
Authorization: Bearer {{token}}

### 4.4c Listar Tareas - Filtrado por Usuario Asignado
GET http://localhost:8000/api/tasks/project/1?assigned_to_id=2
Authorization: Bearer {{token}}

### 4.4d Listar Tareas - Filtrado por Creador
GET http://localhost:8000/api/tasks/project/2?creator_id=1
Authorization: Bearer {{token}}

### 4.4e Listar Tareas - Combinaci√≥n de Filtros
GET http://localhost:8000/api/tasks/project/2?priority_filter=high&status_filter=pending&assigned_to_id=2
Authorization: Bearer {{token}}

### 4.5 Actualizar Tarea - Como ADMIN
PATCH http://localhost:8000/api/tasks/1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "status": "completed",
  "priority": "high",
  "assigned_to_id": 2
}

### 4.6 Actualizar Tarea - READ_WRITE intenta (Error 403)
PATCH http://localhost:8000/api/tasks/1
Authorization: Bearer {{token_read_only}}
Content-Type: application/json

{
  "status": "completed"
}

### 4.7 Eliminar Tarea - Como ADMIN
DELETE http://localhost:8000/api/tasks/1
Authorization: Bearer {{token}}

### 4.8 Eliminar Tarea - READ_WRITE intenta (Error 403)
DELETE http://localhost:8000/api/tasks/2
Authorization: Bearer {{token_read_write}}

### ==========================================
### 5. PRUEBAS DE SEGURIDAD Y ERRORES
### ==========================================

### 5.1 Endpoint protegido sin autenticaci√≥n
GET http://localhost:8000/api/projects
Authorization: 

### 5.2 Endpoint protegido con token expirado
GET http://localhost:8000/api/auth/me
Authorization: Bearer {{token_expired}}

### 5.3 Endpoint p√∫blico - Health check
GET http://localhost:8000/health

### 5.4 Endpoint p√∫blico - Root
GET http://localhost:8000/

### ==========================================
### 6. FLUJOS DE TESTING INTEGRADOS
### ==========================================

### FLUJO 1: Setup Inicial (Ejecutar en orden)

# Paso 1: Login como admin
POST http://localhost:8000/api/auth/login
Content-Type: application/x-www-form-urlencoded

username=admin&password=AdminTaskFlow@2025!

### Paso 2: Crear usuario READ_WRITE
POST http://localhost:8000/api/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "dev_user",
  "email": "dev@example.com",
  "password": "DevPass123!",
  "role": "read_write",
  "first_name": "Developer",
  "last_name": "User"
}

### Paso 3: Crear usuario READ_ONLY
POST http://localhost:8000/api/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "viewer_user",
  "email": "viewer@example.com",
  "password": "ViewerPass123!",
  "role": "read_only",
  "first_name": "Viewer",
  "last_name": "User"
}

### ==========================================
### FLUJO 2: Crear Proyecto y Tareas

# Paso 1: Crear proyecto
POST http://localhost:8000/api/projects
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Testing Project",
  "description": "Proyecto para testing del sistema"
}

### Paso 2: Crear primera tarea
POST http://localhost:8000/api/tasks
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "title": "Task 1 - High Priority",
  "description": "Tarea de alta prioridad",
  "priority": "high",
  "project_id": 2,
  "assigned_to_id": 1
}

### Paso 3: Crear segunda tarea
POST http://localhost:8000/api/tasks
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "title": "Task 2 - Medium Priority",
  "description": "Tarea de prioridad media",
  "priority": "medium",
  "project_id": 2,
  "assigned_to_id": 2
}

### Paso 4: Listar todas las tareas
GET http://localhost:8000/api/tasks/project/2
Authorization: Bearer {{token}}

### ==========================================
### FLUJO 3: Probar Restricciones de Roles

# Paso 1: Login como READ_WRITE
POST http://localhost:8000/api/auth/login
Content-Type: application/x-www-form-urlencoded

username=dev_user&password=DevPass123!

### Paso 2: Intentar listar usuarios (debe permitir)
GET http://localhost:8000/api/users/
Authorization: Bearer {{token_read_write}}

### Paso 3: Intentar crear usuario con rol admin (debe fallar)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token_read_write}}
Content-Type: application/json

{
  "username": "admin2",
  "email": "admin2@example.com",
  "password": "AdminPass123!",
  "role": "admin",
  "first_name": "Admin",
  "last_name": "Two"
}

### Paso 4: Crear usuario con rol read_only (debe funcionar)
POST http://localhost:8000/api/users/
Authorization: Bearer {{token_read_write}}
Content-Type: application/json

{
  "username": "readonly2",
  "email": "readonly2@example.com",
  "password": "ReadonlyPass123!",
  "role": "read_only",
  "first_name": "Readonly",
  "last_name": "Two"
}

### ==========================================
### NOTAS DE TESTING Y VARIABLES
### ==========================================

# VARIABLES A USAR:
# {{token}}             - Token JWT del usuario admin
# {{token_read_write}}  - Token JWT de usuario con rol read_write
# {{token_read_only}}   - Token JWT de usuario con rol read_only

# PROCEDIMIENTO:
# 1. Ejecuta "1.1 Login - Obtener Token ADMIN"
# 2. Copia el valor de "access_token" del response
# 3. En VS Code: Ctrl+Shift+P ‚Üí "REST Client: Set Extended Variables"
#    O usa Find and Replace (Ctrl+H):
#    - Find: {{token}}
#    - Replace: [pega el token aqu√≠]
# 4. Para otros roles, repite el proceso con sus credenciales

# CREDENCIALES DE PRUEBA:
# Admin:      admin / AdminTaskFlow@2025!
# Primero crea los usuarios dev_user y viewer_user con los requests 2.1 y 2.2

# C√ìDIGOS DE RESPUESTA ESPERADOS:
# 200 OK                  - Request exitoso
# 201 Created             - Recurso creado
# 204 No Content          - Eliminaci√≥n exitosa
# 400 Bad Request         - Error en datos
# 401 Unauthorized        - Sin autenticaci√≥n
# 403 Forbidden           - Sin autorizaci√≥n
# 404 Not Found           - Recurso no existe
# 422 Unprocessable Entity - Error de validaci√≥n

### ==========================================
### FILTROS DISPONIBLES PARA TAREAS
### ==========================================

# ENDPOINT: GET /api/tasks/project/{project_id}
# Par√°metros de filtro (todos opcionales):
# - status_filter: pending, in_progress, review, completed
# - priority_filter: low, medium, high, critical
# - assigned_to_id: ID del usuario asignado
# - creator_id: ID del creador de la tarea
# - skip: n√∫mero de registros a saltar (default: 0)
# - limit: n√∫mero m√°ximo de resultados (default: 50, m√°ximo: 200)

# EJEMPLOS:
# /api/tasks/project/2?status_filter=pending
# /api/tasks/project/2?priority_filter=high&status_filter=in_progress
# /api/tasks/project/2?assigned_to_id=2
# /api/tasks/project/2?creator_id=1&priority_filter=critical
# /api/tasks/project/2?skip=10&limit=25

# ENDPOINT: GET /api/tasks/my-tasks
# Par√°metros de filtro (todos opcionales):
# - status_filter: pending, in_progress, review, completed
# - priority_filter: low, medium, high, critical
# - project_id: ID del proyecto a filtrar
# - skip: n√∫mero de registros a saltar (default: 0)
# - limit: n√∫mero m√°ximo de resultados (default: 50, m√°ximo: 200)

